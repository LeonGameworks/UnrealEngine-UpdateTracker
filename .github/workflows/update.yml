name: Unreal Engine Update Tracker

on:
  workflow_dispatch:    # 手動実行
  schedule:
    - cron: '0 23 * * *'   # 毎日 23:00 UTC（日本時間 08:00）

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      # メイン処理（要約生成＆Discussions投稿）
      - name: Run Update Tracker
        env:
          UE_REPO_PAT: ${{ secrets.UE_REPO_PAT }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          DISCUSSION_REPO: ${{ secrets.DISCUSSION_REPO }}
          DISCUSSION_REPO_PAT: ${{ secrets.DISCUSSION_REPO_PAT }}
          # オプション（必要ならSecretsではなくVariablesでもOK）
          REPORT_LANGUAGE: "Japanese"
          GEMINI_MODEL: "gemini-1.5-flash"
          COMMIT_SCAN_LIMIT: "6h"
          DISCUSSION_CATEGORY: "Daily Reports"
        run: |
          echo "Running Unreal Engine Update Tracker..."
          # プロジェクトによって main.py or scripts/main.py です。ログでは scripts/main.py でした。
          if [ -f scripts/main.py ]; then
            python scripts/main.py
          else
            python main.py
          fi

      # Slack 通知：リンクだけ送る（長文は送らない）
      - name: Notify Slack (link only)
        if: success() && secrets.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          DISCUSSION_REPO: ${{ secrets.DISCUSSION_REPO }}
        run: |
          DISCUSSION_URL="https://github.com/${DISCUSSION_REPO}/discussions"
          # 日本語メッセージにしたい場合は text を書き換えてOK
          PAYLOAD=$(jq -n --arg url "$DISCUSSION_URL" --arg msg "🚀 Unreal Engine Update Report has been posted!  <$DISCUSSION_URL|Open on GitHub Discussions>" '{text: $msg}')
          curl -X POST -H 'Content-type: application/json' --data "$PAYLOAD" "$SLACK_WEBHOOK_URL"

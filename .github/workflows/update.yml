name: Unreal Engine Update Tracker

on:
  workflow_dispatch:    # æ‰‹å‹•å®Ÿè¡Œ
  schedule:
    - cron: '0 23 * * *'   # æ¯æ—¥ 23:00 UTCï¼ˆæ—¥æœ¬æ™‚é–“ 08:00ï¼‰

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      # ãƒ¡ã‚¤ãƒ³å‡¦ç†ï¼ˆè¦ç´„ç”Ÿæˆï¼†DiscussionsæŠ•ç¨¿ï¼‰
      - name: Run Update Tracker
        env:
          UE_REPO_PAT: ${{ secrets.UE_REPO_PAT }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          DISCUSSION_REPO: ${{ secrets.DISCUSSION_REPO }}
          DISCUSSION_REPO_PAT: ${{ secrets.DISCUSSION_REPO_PAT }}
          # ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆå¿…è¦ãªã‚‰Secretsã§ã¯ãªãVariablesã§ã‚‚OKï¼‰
          REPORT_LANGUAGE: "Japanese"
          GEMINI_MODEL: "gemini-1.5-flash"
          COMMIT_SCAN_LIMIT: "6h"
          DISCUSSION_CATEGORY: "Daily Reports"
        run: |
          echo "Running Unreal Engine Update Tracker..."
          # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã‚ˆã£ã¦ main.py or scripts/main.py ã§ã™ã€‚ãƒ­ã‚°ã§ã¯ scripts/main.py ã§ã—ãŸã€‚
          if [ -f scripts/main.py ]; then
            python scripts/main.py
          else
            python main.py
          fi

      # Slack é€šçŸ¥ï¼šãƒªãƒ³ã‚¯ã ã‘é€ã‚‹ï¼ˆé•·æ–‡ã¯é€ã‚‰ãªã„ï¼‰
      - name: Notify Slack (link only)
        if: success() && secrets.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          DISCUSSION_REPO: ${{ secrets.DISCUSSION_REPO }}
        run: |
          DISCUSSION_URL="https://github.com/${DISCUSSION_REPO}/discussions"
          # æ—¥æœ¬èªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã—ãŸã„å ´åˆã¯ text ã‚’æ›¸ãæ›ãˆã¦OK
          PAYLOAD=$(jq -n --arg url "$DISCUSSION_URL" --arg msg "ğŸš€ Unreal Engine Update Report has been posted!  <$DISCUSSION_URL|Open on GitHub Discussions>" '{text: $msg}')
          curl -X POST -H 'Content-type: application/json' --data "$PAYLOAD" "$SLACK_WEBHOOK_URL"
